{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }} | Admin Panel{% endblock %}

{% block content %}
<section class="page-header">
    <h1>{{ title }}</h1>
    <p>Fill the form below to {{ title|lower }}.</p>
</section>

{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="alert {{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="form-container">
    <form method="POST" id="event-form">
        {% csrf_token %}
        {{ form.non_field_errors }}
        {% for field in form %}
            <div class="form-group">
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}
                    <small class="help-text">{{ field.help_text }}</small>
                {% endif %}
                <p class="error-message" id="{{ field.id_for_label }}-error" style="color: red; margin-top: 5px;"></p>
                {% for error in field.errors %}
                    <p class="error-default" style="color: red; margin-top: 5px;">{{ error }}</p>
                {% endfor %}
            </div>
        {% endfor %}
        <button type="submit" class="btn primary">Save</button>
        <a href="{% url 'profiles:admin-event-list' %}" class="btn outline">Cancel</a>
    </form>
</div>

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<script>
$(document).ready(function() {
    function clearErrors() {
        $('.error-message').text(''); 
        $('.error-default').hide();  
        $('.form-group').removeClass('has-error'); 
    }

    $('#event-form').on('submit', function(e) { 
        e.preventDefault(); 
        clearErrors(); 

        var form = $(this);
        var url = "{% url 'profiles:admin-event-add' %}";
        var data = form.serialize();

        $.ajax({
            type: 'POST',
            url: url,
            data: data,
            headers: {
                'X-Requested-With': 'XMLHttpRequest' 
            },
            success: function(response) {
                swal({
                    title: "Success!",
                    text: response.message,
                    icon: "success",
                    button: "OK",
                }).then(() => {
                    window.location.href = "{% url 'profiles:admin-event-list' %}";
                });
            },
            error: function(xhr) {
                var response = xhr.responseJSON;
                
                swal("Validation Error!", "Please correct the errors in the form.", "error");

                if (response.errors) {
                    for (var fieldName in response.errors) {
                        var fieldElement = $('#id_' + fieldName);
                        fieldElement.closest('.form-group').addClass('has-error');
                        
                        var errorContainer = $('#' + fieldElement.attr('id') + '-error');
                        errorContainer.text(response.errors[fieldName].join(' '));
                    }
                } else {
                    swal("Error!", response.message || "An unexpected error occurred.", "error");
                }
            }
        });
    });
});
</script>
{% endblock %}
{% endblock %}